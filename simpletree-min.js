var STree=function(e,t,n){this.container=e,this.list=null,this.nodes=t,this.options=n,this.eventListeners={},this.draggedNode=null,this.pathAttribute="label",this.pathSeparator="/",this.LIST_TAG="ul",this.LIST_ITEM_TAG="li",this.LIST_LABEL_TAG="div",this.LIST_LABEL_EXPAND_TAG="span",this.LIST_LABEL_TEXT_TAG="span",this.LIST_ICON_TAG="span",this.LIST_FOLDER_LINE_TAG="div",this.LIST_ITEM_LINE_TAG="div",this.LIST_FOLDER_EXPANDED="&#x203A;",this.LIST_FOLDER_COLLAPSED="&#x203A;",this.EVENT_ITEM_SELECT="stree-item-select",this.EVENT_ITEM_MOVE="stree-item-move",this.EVENT_FOLDER_EXPAND="stree-folder-expand",this.addEventListener=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},this.sendEvent=function(e,t){var n=this.eventListeners[e];if(n&&n.length>0)for(var i=0;i<n.length;i++)n[i].call(this,t)},this.onNodeExpanded=function(e){var t={node:e};this.sendEvent(this.EVENT_FOLDER_EXPAND,t)},this.onNodeSelected=function(e){var t={node:e};this.sendEvent(this.EVENT_ITEM_SELECT,t)},this.onNodeMoved=function(e,t,n){var i={node:e,oldPath:t,newPath:n};this.sendEvent(this.EVENT_ITEM_MOVE,i)},this.getNewId=function(e){var t=this.container.id?this.container.id+"-":"";return t+"stree-"+Math.round(Math.pow(36,e+1)-Math.random()*Math.pow(36,e)).toString(36).slice(1)},this.getOnNodeExpandListener=function(e,t){return function(n){e.expanded?(e.expanded=!1,e.listEl.classList.remove("stree-list-expanded"),e.expandEl.innerHTML=t.LIST_FOLDER_COLLAPSED,e.expandEl.classList.remove("expanded")):(e.expanded=!0,e.listEl.classList.add("stree-list-expanded"),e.expandEl.innerHTML=t.LIST_FOLDER_EXPANDED,e.expandEl.classList.add("expanded")),t.onNodeExpanded.call(t,e)}},this.addNodeExpand=function(e,t,n){var i=document.createElement(this.LIST_LABEL_EXPAND_TAG);i.classList.add("stree-item-expand"),e.children&&e.children.length>0?(i.classList.add("stree-item-folder"),i.innerHTML=this.LIST_FOLDER_COLLAPSED,e.onExpand||(e.onExpand=this.getOnNodeExpandListener(e,this)),i.addEventListener("click",e.onExpand)):(i.classList.add("stree-item-default"),i.innerHTML=""),e.expandEl=i,n.appendChild(i)},this.removeNode=function(e,t){var n=!1;if(e.children&&e.children.length>0)for(var i=0;i<e.children.length;i++){var s=e.children[i];if(s.id===t.id){e.children.splice(i,1),e.listEl.removeChild(s.el),n=!0;break}}return 0===e.children.length&&(e.el.removeChild(e.listEl),delete e.listEl,e.expandEl.removeEventListener("click",e.onExpand),delete e.onExpand,e.expandEl.classList.remove("stree-item-folder"),e.expandEl.classList.add("stree-item-default"),e.expandEl.innerHTML=""),n},this.removeNodeById=function(e){var t=this.getNodeById(e);return t?this.removeNode(t.parent,t):!1},this.getNodeById=function(e,t){var n=t?t:this.nodes;if(n.id===e)return n;if(!(n.children&&n.children.length>0))return null;for(var i=0;i<n.children.length;i++)if(cNode=this.getNodeById(e,n.children[i]),cNode)return cNode},this.getNodePath=function(e,t){for(var n=e,i=t?this.pathSeparator+e.label:"";!n.isRoot;)i=this.pathSeparator+n.parent.label+i,n=n.parent;return i},this.moveNodeTo=function(e,t){if(e&&t){var n=this.getNodePath(e),i=e.parent;this.removeNode(i,e),e.parent=t,t.children||(t.children=[]),t.children.push(e),t.listEl||(t.listEl=this.getNodeList(t.parent),t.el.appendChild(t.listEl),t.expandEl.classList.remove("stree-item-default"),t.expandEl.classList.add("stree-item-folder"),t.expandEl.innerHTML=this.LIST_FOLDER_COLLAPSED,t.onExpand||(t.onExpand=this.getOnNodeExpandListener(t,this)),t.expandEl.addEventListener("click",t.onExpand)),t.listEl.appendChild(e.el);var s=this.getNodePath(e);this.onNodeMoved(e,n,s)}},this.getOnSelectListener=function(e,t){return function(n){if(!n.srcElement.classList.contains("stree-item-expand")){var i=t.selectedNode;i&&(i.selected=!1,i.labelEl.classList.remove("stree-item-selected")),e.selected=!0,e.labelEl.classList.add("stree-item-selected"),t.selectedNode=e,t.onNodeSelected.call(t,e),e.children&&e.children.length>0&&e.onExpand&&e.onExpand.call(this,n)}}},this.getOnMouseOverListener=function(e,t){return function(t){e.el.classList.add("hover"),e.labelTextEl.classList.add("hover")}},this.getOnMouseOutListener=function(e,t){return function(t){e.el.classList.remove("hover"),e.labelTextEl.classList.remove("hover")}},this.getOnDragListener=function(e,t){return function(n){console.log("Dragged: "+e.label),t.draggedNode=e}},this.getOnDropListener=function(e,t){return function(n){console.log("Dropped on: "+e.label),t.draggedNode.parent.id!=e.id&&t.draggedNode.id!=e.id&&t.moveNodeTo(t.draggedNode,e),t.draggedNode=null}},this.getContextMenuListener=function(e,t){return function(n){t.contextMenu&&(t.contextMenu.visible&&t.contextMenu.hideMenu(),t.ctxNode=e,e.contextMenu&&e.contextMenu.items?t.contextMenu.refreshMenu(e.contextMenu.override,e.contextMenu.items):t.contextMenu.refreshMenu(!1),t.contextMenu.showMenu(n.clientX,n.clientY,{ctxNode:t.ctxNode}),n.preventDefault())}},this.addNodeIcon=function(e,t){var n=document.createElement(this.LIST_ICON_TAG);n.classList.add("stree-item-icon"),e.children&&e.children.length>0?n.innerHTML=Icon.get("FOLDER_ICON"):n.innerHTML=Icon.get("FILE_ICON"),t.appendChild(n)},this.addNodeLabel=function(e,t){var n=document.createElement(this.LIST_LABEL_TAG);n.classList.add("stree-item-label"),this.addNodeExpand(e,t,n),this.nodes.useIcon&&this.addNodeIcon(e,n);var i=document.createElement(this.LIST_LABEL_TEXT_TAG);i.classList.add("stree-item-label-text"),e.labelTextEl=i,e.label&&(i.innerHTML=e.label,n.setAttribute("title",e.label)),n.appendChild(i),e.onSelect=this.getOnSelectListener(e,this),n.addEventListener("click",e.onSelect),e.onMouseOver=this.getOnMouseOverListener(e,this),n.addEventListener("mouseover",e.onMouseOver),e.onMouseOut=this.getOnMouseOutListener(e,this),n.addEventListener("mouseout",e.onMouseOut),e.isRoot||(n.setAttribute("draggable",!0),e.onDrag=this.getOnDragListener(e,this),n.addEventListener("dragstart",e.onDrag)),e.onDrop=this.getOnDropListener(e,this),n.addEventListener("drop",e.onDrop),n.addEventListener("dragover",function(e){e.preventDefault()}),e.labelEl=n,t.appendChild(n)},this.addFolderLine=function(e,t){if(this.nodes.folderLines){var n=document.createElement(this.LIST_FOLDER_LINE_TAG);n.classList.add("stree-folder-line"),t.appendChild(n)}},this.addItemLine=function(e,t){if(this.nodes.folderLines){var n=document.createElement(this.LIST_ITEM_LINE_TAG);n.classList.add("stree-item-line"),t.appendChild(n)}},this.addNodeElem=function(e,t,n,i,s,d){var l=document.createElement(n);l.setAttribute("id",i);for(var r=0;r<s.length;r++)l.classList.add(s[r]);return t&&(t.children&&t.children.length>0&&this.addFolderLine(t,l),this.addNodeLabel(t,l)),e.el?e.el.appendChild(l):e.appendChild(l),l},this.getNodeList=function(e){var t=this.addNodeElem(e,null,this.LIST_TAG,this.getNewId(5),["stree-list"],0);return t},this.createRootNode=function(e){this.container.classList.add("stree"),e.isRoot=!0,this.list=this.getNodeList(this.container),this.list.classList.add("stree-list-root"),e.parent=null,e.id=this.getNewId(5),e.level=0,e.el=this.addNodeElem(this.list,e,this.LIST_ITEM_TAG,e.id,["stree-list-item"],e.level),e.listEl=this.getNodeList(e)},this.addNode=function(e,t){t.children||(t.children=[]),t.children.push(e),this.createNode(e,t)},this.createChildNode=function(e,t){t.listEl||(t.listEl=this.getNodeList(t),t.el.appendChild(t.listEl),t.expandEl.classList.remove("stree-item-default"),t.expandEl.classList.add("stree-item-folder"),t.expandEl.innerHTML=this.LIST_FOLDER_COLLAPSED,t.onExpand||(t.onExpand=this.getOnNodeExpandListener(t,this)),t.expandEl.addEventListener("click",t.onExpand)),e.isRoot=!1,e.parent=t,e.id=this.getNewId(5),e.level=t.level+1,e.el=this.addNodeElem(t.listEl,e,this.LIST_ITEM_TAG,e.id,["stree-list-item"],e.level)},this.createNode=function(e,t){if(e.expanded=!1,t?this.createChildNode(e,t):this.createRootNode(e),e.children&&e.children.length>0){e.isFolder=!0;for(var n=0;n<e.children.length;n++){var i=e.children[n];this.createNode(i,e)}}},this.getHideMenuHandler=function(e){return function(t){if(!(t.srcElement.classList.contains("stree-list-item")||t.srcElement.classList.contains("stree-item-label")||t.srcElement.classList.contains("stree-item-expand")||t.srcElement.classList.contains("stree-item-label-text")))return!0;var n;return"DIV"===t.srcElement.tagName.toUpperCase()?n=t.srcElement.parentElement:t.srcElement.tagName.toUpperCase&&(n=t.srcElement.parentElement.parentElement),n&&n.id===e.ctxNode.id?!1:!0}},this.addContextMenu=function(e){if(e){e.id||(e.id=this.getNewId(5)),this.contextMenu=new SContext(e),this.contextMenu.addHideMenuHandler(this.getHideMenuHandler(this));for(var t=document.querySelectorAll("#"+this.container.id+" .stree-item-label"),n=0;n<t.length;n++){var i=t[n],s=this.getNodeById(i.parentElement.id);i.addEventListener("contextmenu",this.getContextMenuListener(s,this))}}},this.processOptions=function(){this.options&&this.addContextMenu(this.options.contextMenu)},this.createTree=function(){this.createNode(this.nodes),this.processOptions()},this.createTree()},SContext=function(e,t){function n(e){return e&&"[object Function]"==={}.toString.call(e)}this.menu=e,this.menuEl=null,this.hideMenuHandlers=[],this.addHideMenuHandler=function(e){this.hideMenuHandlers.push(e)},this.windowClickListener=function(e){return function(t){if(e.visible){for(var n=0;n<e.hideMenuHandlers.length;n++)if(!e.hideMenuHandlers[n].call(e,t))return;var i=t.srcElement.classList;i.contains("stree-ctxmenu")||i.contains("stree-ctxmenu-item")||i.contains("stree-ctxmenu-line")||e.visible&&e.hideMenu()}}},this.onMenuclick=function(e,t){return function(n){e.hideMenu(),t.call(e,n)}},this.showMenu=function(e,t,n){this.visible||(this.menuTriggerOptions=n,this.menuEl.style.left=e+"px",this.menuEl.style.top=t+"px",this.menuEl.classList.add("show"),this.visible=!0)},this.hideMenu=function(){this.visible&&(this.menuEl.classList.remove("show"),this.visible=!1)},this.addMenuItem=function(e,t){var i=document.createElement("span");i.classList.add("stree-ctxmenu-item"),t&&i.classList.add("mark"),e.label&&(i.innerHTML=e.label),n(e.onclick)&&i.addEventListener("click",this.onMenuclick(this,e.onclick)),this.menuEl.appendChild(i)},this.addLineItem=function(e){var t=document.createElement("span");t.classList.add("stree-ctxmenu-line"),e&&t.classList.add("mark"),t.innerHTML="&nbsp;",this.menuEl.appendChild(t)},this.addItem=function(e){e.line?this.addLineItem():this.addMenuItem(e)},this.createMenu=function(){var e=document.createElement("div");e.setAttribute("id",this.menu.id),e.classList.add("stree-ctxmenu"),this.menuEl=e;var t=this.menu.items;if(t&&t.length>0)for(var n=0;n<t.length;n++)this.addItem(t[n]);document.body.appendChild(e),window.addEventListener("click",this.windowClickListener(this)),window.addEventListener("contextmenu",this.windowClickListener(this))},this.refreshMenu=function(e,t){var n=!1;if(e)this.menuEl.innerHTML="",n=!0;else{for(var i=this.menuEl.querySelectorAll(".mark"),s=0;s<i.length;s++)this.menuEl.removeChild(i[s]);t&&t.length>0?(this.addLineItem(!0),n=!0):(this.menuEl.innerHTML="",t=this.menu.items,n=!1)}if(t&&t.length>0)for(var d=0;d<t.length;d++){var l=t[d];l.line?this.addLineItem(n):this.addMenuItem(l,n)}},this.initMenu=function(){return this.menu&&this.menu.id?void this.createMenu():void console.log("Invalid menu structure")},this.initMenu()},Icon={get:function(e){return Icon[e]},FILE_ICON:'<?xml version="1.0" encoding="iso-8859-1"?><svg class="sicon-svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" fill="#efefef" stroke="#dddddd"><path stroke-width="12px" d="M447.168,134.56c-0.537-1.284-1.319-2.451-2.304-3.435l-128-128c-2.002-1.991-4.707-3.114-7.531-3.125H74.667C68.776,0,64,4.776,64,10.667v490.667C64,507.224,68.776,512,74.667,512h362.667c5.891,0,10.667-4.776,10.667-10.667V138.667C447.997,137.256,447.714,135.86,447.168,134.56z"/></svg>',FOLDER_ICON:'<?xml version="1.0" encoding="iso-8859-1"?><svg class="sicon-svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 491.52 491.52" fill="#efefef" stroke="#dddddd"><path stroke-width="12px" d="M207.05,102.4l-53.53-51.2 H0v389.12h491.52 V102.4H207.05z"/><rect fill="#dddddd" x="194.56" y="368.64" width="235.52" height="20.48"/><rect fill="#dddddd" x="296.96" y="317.44" width="133.12" height="20.48"/></svg>'};
